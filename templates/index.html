<!DOCTYPE html>
<html>
<head>
    <title>ML Model Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">   
</head>
<body>
    <div class="container">
        <h1>Identificator</h1>
        <h2>        
            <p>Right now this uses 'openai/clip-vit-base-patch32' but this will soon be trainable and configurable.</p>
        <h2>

        <!-- Fine-tuning Form -->
        <div class="upload-form">
            <h2>Fine-tune Model</h2>
            <form id="finetune-form" enctype="multipart/form-data">
                <p>Upload ZIP file containing image folders (coming soon!):</p>
                <input type="file" id="zip-file" name="file" accept=".zip" required>
                <button type="submit" disabled>Upload and Fine-tune</button>
            </form>
        </div>

        <!-- Fine-tuning Results Section -->
        <div id="finetune-results-container" class="results" style="display: none;">
            <h2>Fine-tuning Results</h2>
            <p><strong>Loss History:</strong></p>
            <ul id="finetune-loss-results"></ul>
        </div>

        <!-- Single Image Classification Form -->
        <div class="upload-form">
            <h2>Classify Image</h2>
            <form id="classify-form" enctype="multipart/form-data">
                <p>Upload image for classification:</p>
                <input type="file" id="image-file" name="file" accept="image/*" required>
                <div class="image-preview" style="margin: 1em 0;">
                    <img id="classimg" style="max-width: 300px; display: none;">
                </div>
                <p>CSV Class List<textarea id="classes-csv" name="classes" class="csv_classes" required 
                     placeholder="e.g., cat,dog,bird"></textarea></p>
                <button type="submit">Upload and Classify</button>
            </form>
        </div>

        <!-- Batch Classification Form -->
        <div class="upload-form">
            <h2>Batch Classify Images</h2>
            <form id="batch-classify-form" enctype="multipart/form-data">
                <p>Upload multiple images (max 5):</p>
                <input type="file" id="batch-files" name="files" accept="image/*" multiple required>
                <p>CSV Class List<textarea id="batch-classes-csv" name="classes" class="csv_classes" required 
                     placeholder="e.g., cat,dog,bird"></textarea></p>
                <button type="submit">Upload and Classify Batch</button>
            </form>
        </div>

        <!-- Classification Results Section -->
        <div id="results-container" class="results" style="display: none;">
            <h2>Classification Results</h2>
            <p><strong>Image:</strong> <span id="image-name"></span></p>
            <p><strong>Results:</strong></p>
            <ul id="classification-results"></ul>
        </div>

        <!-- Batch Results Section -->
        <div id="batch-results-container" class="results" style="display: none;">
            <h2>Batch Classification Results</h2>
            <p><strong>Classes:</strong> <span id="batch-classes"></span></p>
            <p><strong>Results:</strong></p>
            <ul id="batch-classification-results"></ul>
        </div>

        <!-- Error Section -->
        <div id="error-container" class="error" style="display: none;">
            <h2>Error</h2>
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        // Existing image preview and fine-tune logic remains unchanged
        // ...

        // Batch Classification Form Submission
        document.getElementById('batch-classify-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            // Get and sanitize classes
            const csvInput = document.getElementById('batch-classes-csv');
            let csvValue = csvInput.value.trim();
            const sanitized = csvValue
                .replace(/[^a-zA-Z,]/g, '')
                .toLowerCase()
                .replace(/,+/g, ',')
                .replace(/^,|,$/g, '');
            csvInput.value = sanitized;
            const elements = sanitized.split(',').filter(e => e !== '');

            // Validation
            if (elements.length === 0) {
                alert('Error: Please enter at least one valid class');
                return;
            }
            if (elements.length > 5) {
                alert('Error: Maximum 5 classes allowed');
                return;
            }
            if (elements.some(e => !/^[a-z]+$/.test(e))) {
                alert('Error: Classes must contain only letters');
                return;
            }

            // Prepare form data
            const formData = new FormData();
            const fileInput = document.getElementById('batch-files');
            const files = fileInput.files;

            // File validation
            if (files.length === 0) {
                alert('Please select at least one file');
                return;
            }
            if (files.length > 5) {
                alert('Maximum 5 files allowed per batch');
                return;
            }

            // Add files and classes
            Array.from(files).forEach(file => {
                formData.append('files', file);
            });
            formData.append('classes', elements.join(','));

            try {
                const response = await fetch('/classify/batch', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    showError(errorData.error || 'Batch processing failed');
                    return;
                }

                const data = await response.json();
                showBatchResults(data.classes, data.results);
            } catch (error) {
                showError('Failed to connect to the server. Please try again later.');
            }
        });

        function showBatchResults(classes, results) {
            document.getElementById('batch-results-container').style.display = 'block';
            document.getElementById('error-container').style.display = 'none';
            
            document.getElementById('batch-classes').textContent = classes.join(', ');
            const resultsList = document.getElementById('batch-classification-results');
            resultsList.innerHTML = '';

            results.forEach(result => {
                const listItem = document.createElement('li');
                if (result.error) {
                    listItem.innerHTML = `
                        <strong>${result.image}</strong>: 
                        <span class="error-text">${result.error}</span>
                    `;
                } else {
                    listItem.innerHTML = `
                        <strong>${result.image}</strong>:
                        ${result.predicted_class} (${result.confidence.toFixed(2)}%)
                    `;
                }
                resultsList.appendChild(listItem);
            });
        }

        // Existing showResults and showError functions remain unchanged
        // ...
    </script>
</body>
</html>